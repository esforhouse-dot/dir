<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Neon CAD - Engineering</title>
    
    <!-- ПОДКЛЮЧЕНИЕ СТИЛЕЙ -->
    <link rel="stylesheet" href="./src/style.css">
    <!-- Шрифт для CAD интерфейса (моноширинный) -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* Прелоадер: скрываем интерфейс до загрузки */
        body {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease-in;
            background-color: #0f1115;
            overflow: hidden;
            
            /* CSS ЗАЩИТА: Если JS сломался, CSS сам покажет сайт через 5 секунд */
            animation: force-reveal 0.1s forwards 5s; 
        }
        
        body.loaded {
            opacity: 1;
            visibility: visible;
            animation: none; /* Отменяем анимацию, если JS сработал раньше */
        }

        /* Ключевые кадры для аварийного появления */
        @keyframes force-reveal {
            to { opacity: 1; visibility: visible; }
        }
    </style>

    <!-- API Яндекса (Замените apikey на свой!) -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=b937403b-296f-43ed-9b61-aaa6b8a99e03&lang=ru_RU" type="text/javascript"></script>
</head>
<body>

    <!-- UI Элементы -->
    <div id="save-indicator"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Сохранено</div>

    <div id="left-panel">
        <div id="tool-trigger"><svg class="trigger-icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg><span class="trigger-text" id="active-tool-name">ИНСТРУМЕНТ</span></div>
        <div id="esc-btn">ESC</div>
    </div>

    <div id="tools-menu">
        <button class="minimal-btn" data-tool="line" data-label="Линия">Линия (Кабель)</button>
        <button class="minimal-btn" data-tool="polygon" data-label="Полигон">Полигон (Зона)</button>
        <button class="minimal-btn" data-tool="task" data-label="Задача">Задача (Work Order)</button>
        <div class="divider" style="width:100%; height:1px; background:#333; margin: 4px 0;"></div>
        <button class="minimal-btn" data-tool="subscriber" data-label="Абонент">Абонент (Дом)</button>
        <button class="minimal-btn" data-tool="light" data-label="Светильник">Светильник</button>
        <button class="minimal-btn" data-tool="pole" data-label="Опора">Опора</button>
        <button class="minimal-btn" data-tool="cabinet" data-label="Щит электрический">Щит электрический</button>
        <button class="minimal-btn" data-tool="flag" data-label="Флаг">Флаг</button>
        <button class="minimal-btn" data-tool="star" data-label="Звезда">Звезда</button>
        <button class="minimal-btn" data-tool="substation" data-label="ТП (подстанция)">ТП (подстанция)</button>
        <button class="minimal-btn" data-tool="text" data-label="Текст">Текстовый блок</button>
    </div>

    <div id="context-menu"></div>

    <!-- Модалка переименования -->
    <div id="modal-overlay">
        <div id="modal-box">
            <h3>Подпись объекта</h3>
            <input type="text" id="modal-input" placeholder="Введите текст..." >
            <div class="modal-btns">
                <button id="btn-modal-cancel" class="modal-btn">Отмена</button>
                <button id="btn-modal-save" class="modal-btn" style="background:#00AEEF;color:#fff;">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Модалка кабеля -->
    <div id="cable-modal-overlay">
        <div id="cable-modal-box">
            <div class="modal-header">Свойства кабеля</div>
            <div class="form-group">
                <label>Функциональное назначение</label>
                <div class="select-wrapper">
                    <select id="cable-type-select">
                        <option value="power">Силовая линия (Электрика)</option>
                        <option value="low_current">Слаботочная линия</option>
                        <option value="fiber">Оптическая линия (ВОЛС)</option>
                    </select>
                </div>
            </div>
            <div id="cable-dynamic-fields"></div>
            <div class="form-group">
                <label>Способ прокладки</label>
                <div class="select-wrapper">
                    <select id="cable-install-select">
                        <option value="air">Воздушная (ВЛ / ВЛИ)</option>
                        <option value="ground">Подземная (В грунте)</option>
                        <option value="water">Подводная</option>
                        <option value="building">По фасаду / Внутри здания</option>
                    </select>
                </div>
            </div>
            <div class="modal-btns">
                <button id="btn-cable-cancel" class="modal-btn secondary">Отмена</button>
                <button id="btn-cable-save" class="modal-btn primary">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- МОДАЛКА ЗАДАЧИ -->
    <div id="task-modal-overlay">
        <div id="task-modal-box">
            <div class="modal-header" style="border-bottom-color: var(--neon-blue);">Карточка задачи</div>
            
            <div class="form-group">
                <label>Описание задачи</label>
                <input type="text" id="task-desc-input" placeholder="Что нужно сделать?">
            </div>

            <div class="form-group">
                <label>Статус исполнения</label>
                <div class="select-wrapper">
                    <select id="task-status-select">
                        <option value="active">В работе (Выполняется)</option>
                        <option value="done">Выполнено</option>
                        <option value="canceled">Закрыто без выполнения</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label style="color: var(--text-muted);">Комментарий / Причина</label>
                <textarea id="task-comment-input" rows="3" placeholder="Заметки, причины отмены или возврата..."></textarea>
            </div>

            <div class="modal-btns">
                <button id="btn-task-cancel" class="modal-btn secondary">Отмена</button>
                <button id="btn-task-save" class="modal-btn primary">Сохранить</button>
            </div>
        </div>
    </div>

    <div id="top-toolbar">
        <div class="search-box">
            <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <input type="text" id="search-input" placeholder="Адрес..." enterkeyhint="search" >
        </div>
        <div class="divider"></div>
        <div id="palette" style="display:flex; gap:8px;"></div>
        
        <button id="btn-theme" class="icon-btn" title="Сменить тему">
            <svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
        </button>

        <div class="divider"></div>

        <button id="btn-eraser" class="icon-btn" title="Ластик">
            <svg viewBox="0 0 24 24"><path d="M15.14 3c.51 0 1.02.2 1.41.59l2.86 2.86c.78.78.78 2.05 0 2.83l-7.03 7.03-8.8-8.81 7.03-7.02c.39-.39.9-.59 1.41-.59h.12zM5.5 16.7L12 10.2l6.5 6.5-1.41 1.41-5.09-5.09-5.09 5.09L5.5 16.7zM18 19v2H6v-2h12z"/></svg>
        </button>

        <div class="divider"></div>
        
        <button id="btn-style" class="icon-btn" title="Стиль линии">
            <svg viewBox="0 0 24 24"><path d="M3 17h18v2H3zm0-5h18v2H3zm0-5h18v2H3z"/></svg>
        </button>

        <div class="divider"></div>
        <button id="btn-ruler" class="icon-btn active" title="Размеры"><svg viewBox="0 0 24 24"><path d="M21.66 10.25L13.75 2.34c-.39-.39-1.02-.39-1.41 0L2.34 12.34c-.39.39-.39 1.02 0 1.41l7.91 7.91c.39.39 1.02.39 1.41 0l10-10c.39-.39.39-1.02 0-1.41zM6.59 16L4 13.41l1-1 1 1 1.41-1.41-1-1 1.42-1.42 1 1 1.41-1.41-1-1 3.54-3.54L19.25 10.5 6.59 16z"/></svg></button>
        
        <div class="opacity-control" title="Прозрачность"><svg class="opacity-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" /><circle cx="12" cy="12" r="3" fill="#fff" stroke="none" /></svg><input type="range" id="opacity-slider" min="10" max="100" value="100" ></div>
        <div class="opacity-control" title="Размер иконок"><svg class="opacity-icon" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg><input type="range" id="icon-scale-slider" min="20" max="200" value="100" ></div>
        <div class="opacity-control" title="Затемнение фона"><svg class="opacity-icon" viewBox="0 0 24 24"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zm-3.21 13.7l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-1 16.95h2V19.5h-2v2.95zm-7.45-3.91l1.41 1.41 1.79-1.8-1.41-1.41-1.79 1.8z"/></svg><input type="range" id="map-dimmer" min="10" max="100" value="100" ></div>
        
        <div class="divider"></div>
        <button id="btn-poi" class="icon-btn" title="Вкл/Откл объекты карты (POI)"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></button>
        <div class="divider"></div>
        <button id="btn-groups" class="icon-btn" title="Группы / Слои"><svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5 9.5 9.75 12 11zm0 2.5l-5-2.5-5 2.5 10 5 10-5-5-2.5-5 2.5z"/></svg></button>
        <div class="divider"></div>
        <button id="btn-bom" class="icon-btn" title="Смета (BOM)"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg></button>
        <div class="divider"></div>
        <button id="btn-save" class="icon-btn" title="Сохранить"><svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg></button>
        <button id="btn-load" class="icon-btn" title="Загрузить"><svg viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7l-4-4zm0 12H4V8h16v10zM8 13.01l1.41 1.41L11 12.83V17h2v-4.17l1.59 1.59L16 13.01 12.01 9 8 13.01z"/></svg></button>
        <button id="btn-clear" class="icon-btn" title="Очистить"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>
    </div>

    <div id="info-bar">
        <span class="info-label">Z:</span><span id="zoom-val">--</span>
        <div class="info-divider"></div>
        <span class="info-label">Storage:</span><span id="storage-val">0</span> KB
    </div>

    <div id="help-toggle-btn">?</div>
    <div id="help-panel" class="side-panel">
        <div class="panel-header">
            <div class="panel-icon-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00AEEF" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                <span style="color: var(--text-color); font-weight: 700; margin-left: 8px;">Справка</span>
            </div>
            <div class="panel-close">✕</div>
        </div>
        
        <div class="panel-body" style="padding: 15px;">
            <div class="help-section">
                <div class="help-title">
                    <svg viewBox="0 0 24 24"><path d="M13 2v8h6V8c0-3.31-2.69-6-6-6zM5 8v2h6V2c-3.31 0-6 2.69-6 6zm0 2c0 3.86 3.14 7 7 7s7-3.14 7-7h-2c0 2.76-2.24 5-5 5s-5-2.24-5-5H5z"/></svg>
                    УПРАВЛЕНИЕ МЫШЬЮ
                </div>
                <div class="help-row"><div class="key-badge">ЛКМ</div><div class="help-desc">Поставить точку / Выбрать</div></div>
                <div class="help-row"><div class="key-badge">ПКМ</div><div class="help-desc">Свойства / Контекст. меню</div></div>
                <div class="help-row"><div class="key-badge">Drag</div><div class="help-desc">Перемещение карты</div></div>
            </div>
            <div class="help-divider"></div>
            <div class="help-section">
                <div class="help-title">
                    <svg viewBox="0 0 24 24"><path d="M20 5H4c-1.1 0-1.99.9-1.99 2L2 17c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-9 3h2v2h-2V8zm0 3h2v2h-2v-2zM8 8h2v2H8V8zm0 3h2v2H8v-2zm-1 2H5v-2h2v2zm0-3H5V8h2v2zm9 7H8v-2h8v2zm0-4h-2v-2h2v2zm0-3h-2V8h2v2zm3 3h-2v-2h2v2zm0-3h-2V8h2v2z"/></svg>
                    КЛАВИШИ
                </div>
                <div class="help-row"><div class="key-badge">ESC</div><div class="help-desc">Отмена / Закрыть меню</div></div>
                <div class="help-row"><div class="key-badge">TAB</div><div class="help-desc">Меню инструментов</div></div>
                <div class="help-row"><div class="key-badge">ENTER</div><div class="help-desc">Поиск адреса</div></div>
            </div>
            <div class="help-divider"></div>
            <div class="help-section">
                <div class="help-title">
                    <svg viewBox="0 0 24 24"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg>
                    ИНСТРУМЕНТЫ
                </div>
                <div class="help-text-row"><span class="help-label">Ластик:</span><span class="help-desc">Клик удаляет. В меню "Очистить" удаляет всё.</span></div>
                <div class="help-text-row"><span class="help-label">Линия:</span><span class="help-desc">ПКМ по линии для настройки кабеля.</span></div>
            </div>
        </div>
    </div>

    <div id="groups-panel" class="side-panel">
        <div class="panel-header">
            <div class="panel-icon-title"><span>Группы объектов</span></div>
            <div class="panel-close">✕</div>
        </div>
        <div class="panel-body">
            <div id="groups-list"></div>
            <button class="btn-add-group">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> Создать группу
            </button>
        </div>
    </div>

    <div id="bom-panel" class="side-panel">
        <div class="panel-header">
            <div class="panel-icon-title"><span>Смета (BOM)</span></div>
            <div class="panel-close">✕</div>
        </div>
        <div class="panel-body" id="bom-content"></div>
    </div>

    <div id="style-dropdown" class="toolbar-dropdown">
        <div class="style-option" data-style="solid" title="Сплошная"><div class="line-preview solid"></div></div>
        <div class="style-option" data-style="dash" title="Пунктир"><div class="line-preview dash"></div></div>
        <div class="style-option" data-style="dot" title="Точка"><div class="line-preview dot"></div></div>
    </div>

    <input type="file" id="file-input" accept=".json" >
    <div id="map"></div>

    <!-- SVG Defs: АКТУАЛЬНЫЕ ИКОНКИ -->
    <svg style="display: none;">
        <defs>
            <symbol id="icon-cabinet" viewBox="0 0 24 24">
                <rect x="6" y="3" width="12" height="18" fill="#111" stroke="var(--obj-color)" stroke-width="2"/>
                <path d="M13 6 L9 13 H12 L10 19" fill="none" stroke="var(--obj-color)" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>
            </symbol>
            
            <symbol id="icon-flag" viewBox="0 0 24 24">
                <path d="M5 21V5h14l-2 5 2 5H7v6h-2z" fill="none" stroke="var(--obj-color)" stroke-width="2" stroke-linejoin="round"/>
            </symbol>
            
            <symbol id="icon-star" viewBox="0 0 24 24">
                <path d="M12 2l3 7h7l-5.5 4 2 7-6.5-4.5-6.5 4.5 2-7-5.5-4h7z" fill="none" stroke="var(--obj-color)" stroke-width="2" stroke-linejoin="round"/>
            </symbol>
            
            <symbol id="icon-substation" viewBox="0 0 24 24">
                <rect x="2" y="2" width="20" height="20" fill="#111" stroke="var(--obj-color)" stroke-width="2"/>
                <circle cx="8" cy="8" r="3" stroke="var(--obj-color)" stroke-width="1.5" fill="none"/>
                <circle cx="16" cy="16" r="3" stroke="var(--obj-color)" stroke-width="1.5" fill="none"/>
            </symbol>
            
            <symbol id="icon-house" viewBox="0 0 24 24">
                <rect x="3" y="3" width="18" height="18" fill="#111" stroke="var(--obj-color)" stroke-width="2"/>
                <path d="M3 3L21 21" stroke="var(--obj-color)" stroke-width="1" stroke-dasharray="2 2"/>
            </symbol>

            <symbol id="icon-pole" viewBox="0 0 24 24">
                <polygon points="8,4 16,4 20,8 20,16 16,20 8,20 4,16 4,8" fill="#111" stroke="var(--obj-color)" stroke-width="2" stroke-linejoin="round"/>
                <circle cx="12" cy="12" r="2" fill="var(--obj-color)"/>
            </symbol>

            <symbol id="icon-light" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="7.5" fill="#111" stroke="var(--obj-color)" stroke-width="2"/>
                <line x1="8" y1="8" x2="16" y2="16" stroke="var(--obj-color)" stroke-width="2" stroke-linecap="round"/>
                <line x1="16" y1="8" x2="8" y2="16" stroke="var(--obj-color)" stroke-width="2" stroke-linecap="round"/>
            </symbol>

            <!-- ИКОНКА ЗАДАЧИ -->
            <symbol id="icon-task" viewBox="0 0 24 24">
                <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" fill="#111" stroke="var(--obj-color)" stroke-width="2"/>
                <path d="M20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="var(--obj-color)" />
            </symbol>
        </defs>
    </svg>

    <script type="module" src="./src/main.js"></script>
</body>
</html>

/* --- CAD / ENGINEERING STYLE v4.4 (LIGHT THEME FIXES) --- */
:root { 
    --icon-scale: 0.8; 
    --ui-radius: 4px; 
    --map-dim: 100%;

    /* NEON DARK (DEFAULT) */
    --ui-bg: #14181c; 
    --ui-border: rgba(255, 255, 255, 0.15);
    --text-color: #e0e0e0;
    --text-muted: #888;
    --input-bg: #1a1e24; /* Темный фон инпутов */
    --input-border: rgba(255, 255, 255, 0.15);
    --icon-fill: #aaa;
    --neon-blue: #00AEEF; 
    --active-color: #00FF99;
    --danger-color: #FF4444;
    --map-bg: #0f1115;
    
    --map-ground-filter: grayscale(100%) invert(88%) contrast(90%) brightness(calc(var(--map-dim) * 0.8));
    --map-places-filter: grayscale(100%) brightness(120%);
}

/* LIGHT THEME */
body.theme-light {
    --ui-bg: #ffffff;
    --ui-border: rgba(0, 0, 0, 0.15);
    --text-color: #222;
    --text-muted: #666;
    --input-bg: #f0f0f0; /* Светлый фон инпутов */
    --input-border: rgba(0, 0, 0, 0.2);
    --icon-fill: #444;
    --neon-blue: #0077CC;
    --active-color: #00AA44;
    --map-bg: #e6e6e6;
    
    --map-ground-filter: grayscale(0%) brightness(var(--map-dim));
    --map-places-filter: none;
}

body, html { 
    margin: 0; padding: 0; width: 100%; height: 100%; 
    font-family: 'Roboto Mono', 'Segoe UI', monospace; 
    background: var(--map-bg); 
    color: var(--text-color);
    overflow: hidden; touch-action: none; overscroll-behavior: none;
    transition: background 0.3s, color 0.3s;
}

* { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

button, input, select, textarea, .icon-btn, .minimal-btn, .color-btn { touch-action: manipulation; }

/* MAP */
#map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: var(--map-bg); }
[class*="ymaps-2"][class*="-ground-pane"] { filter: var(--map-ground-filter) !important; transition: filter 0.3s ease; }
[class*="ymaps-2"][class*="-places-pane"] { filter: var(--map-places-filter) !important; transition: filter 0.3s ease; }
#map.crosshair-active { cursor: crosshair !important; }
#map.eraser-active { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23FF3333" stroke-width="2"><path d="M18 13v6H6v-6l6-6 6 6z"/><path d="M12 7L6 13"/></svg>') 12 12, crosshair !important; }

/* UI ELEMENTS */
#save-indicator { 
    position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
    background: #004400; border: 1px solid #00aa00; color: #fff; 
    padding: 5px 15px; border-radius: 4px; font-size: 12px; opacity: 0; 
    transition: opacity 0.5s; pointer-events: none; z-index: 6000; display: flex; align-items: center; gap: 5px; 
}
#save-indicator.show { opacity: 1; }

#top-toolbar { 
    position: absolute; top: 15px; left: 50%; transform: translateX(-50%); 
    height: 40px; background: var(--ui-bg); border: 1px solid var(--ui-border); 
    border-radius: var(--ui-radius); padding: 0 10px; display: flex; align-items: center; gap: 4px; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 5000; overflow-x: auto; max-width: 95vw;
}
#top-toolbar::-webkit-scrollbar { display: none; }

.icon-btn { 
    width: 32px; height: 32px; border-radius: 4px; opacity: 0.8; padding: 0; background: transparent; 
    border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.icon-btn:hover { background: rgba(128,128,128,0.1); opacity: 1; }
.icon-btn.active svg { fill: var(--active-color); stroke: var(--active-color); filter: none; }
.icon-btn svg { width: 18px; height: 18px; fill: var(--icon-fill); filter: none; }

.toolbar-dropdown { 
    position: fixed; top: 60px; left: 50%; background: var(--ui-bg); border: 1px solid var(--ui-border); 
    border-radius: 4px; padding: 4px; display: none; flex-direction: column; gap: 4px; 
    z-index: 7000; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}
.toolbar-dropdown.open { display: flex; }
.style-option { width: 40px; height: 24px; background: rgba(128,128,128,0.1); border: 1px solid transparent; border-radius: 2px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.style-option:hover { background: rgba(128,128,128,0.2); border-color: var(--text-muted); }
.line-preview { width: 25px; height: 0; border-bottom-width: 2px; border-bottom-color: var(--text-color); }
.line-preview.solid { border-bottom-style: solid; }
.line-preview.dash { border-bottom-style: dashed; }
.line-preview.dot { border-bottom-style: dotted; }
.divider { height: 20px; background: var(--ui-border); margin: 0 5px; width: 1px; flex-shrink: 0; }

.search-box { height: 28px; background: var(--input-bg); border: 1px solid var(--ui-border); border-radius: 4px; margin-right: 5px; display: flex; align-items: center; padding: 0 5px; }
.search-icon { width: 14px; height: 14px; fill: var(--text-muted); margin-right: 5px; }
#search-input { background: none; border: none; outline: none; font-family: 'Roboto Mono', monospace; font-size: 12px; color: var(--text-color); width: 100px; }

.color-btn { width: 16px; height: 16px; border-radius: 2px; border: 1px solid #555; cursor: pointer; flex-shrink: 0; }
.color-btn.active { transform: scale(1.2); border: 1px solid var(--text-color); box-shadow: none; z-index: 2;}

.opacity-control { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
.opacity-control svg { width: 16px; height: 16px; opacity: 0.7; stroke: var(--text-muted); fill: none; }
input[type=range] { -webkit-appearance: none; width: 50px; height: 2px; background: var(--text-muted); border-radius: 0; outline: none; cursor: pointer; }
input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 10px; height: 10px; border-radius: 2px; background: var(--text-color); cursor: pointer; box-shadow: none; }

#left-panel { position: absolute; top: 70px; left: 15px; z-index: 5001; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
#tool-trigger, #esc-btn { pointer-events: auto; border-radius: var(--ui-radius); background: var(--ui-bg); border: 1px solid var(--ui-border); box-shadow: 0 2px 5px rgba(0,0,0,0.2); height: 36px; min-width: 36px; font-size: 12px; display: flex; align-items: center; justify-content: center; color: var(--neon-blue); cursor: pointer; overflow: hidden; }
#tool-trigger:hover, #esc-btn:hover { background: rgba(128,128,128,0.1); }
#tool-trigger.active-tool { background: var(--ui-bg); border-color: var(--neon-blue); padding: 0 10px; }
.trigger-icon { width: 18px; height: 18px; fill: var(--neon-blue); }
.trigger-text { display: none; color: var(--text-color); text-transform: uppercase; font-weight: bold; }
#tool-trigger.active-tool .trigger-icon { display: none; }
#tool-trigger.active-tool .trigger-text { display: block; }
#esc-btn { color: var(--danger-color); }

#tools-menu { position: fixed; left: 60px; top: 70px; z-index: 6000; border-radius: var(--ui-radius); background: var(--ui-bg); border: 1px solid var(--ui-border); padding: 6px; display: flex; flex-direction: column; gap: 4px; opacity: 0; visibility: hidden; transform: translateX(-10px); transition: 0.2s; min-width: 150px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
#tools-menu.open { opacity: 1; visibility: visible; transform: translateX(0); }
#tools-menu.floating { margin: 0; z-index: 9999; }
.minimal-btn { background: transparent; border: none; color: var(--text-color); font-size: 12px; padding: 6px 10px; border-radius: 4px; font-family: 'Roboto Mono', monospace; text-align: left; cursor: pointer; width: 100%; }
.minimal-btn:hover { background: rgba(128,128,128,0.1); padding-left: 14px; }
.minimal-btn.selected { color: var(--neon-blue); font-weight: bold; background: rgba(0, 174, 239, 0.1); }

.custom-icon { width: 40px; height: 40px; transform: translate(-50%, -50%) scale(var(--icon-scale)); cursor: pointer; }
.custom-icon svg { width: 100%; height: 100%; filter: drop-shadow(0 0 1px #000); }
.neon-light { width: 10px; height: 10px; background: #000; border: 1.5px solid var(--obj-color, #ffcc00); border-radius: 50%; position: relative; transform: translate(-50%, -50%) scale(var(--icon-scale)); cursor: pointer; box-shadow: none; }
[class*="ymaps-2"][class*="-polyline"] { opacity: 0.9 !important; }

#info-bar { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); z-index: 4000; border-radius: 4px; background: var(--ui-bg); color: var(--text-muted); border: 1px solid var(--ui-border); font-size: 10px; padding: 4px 10px; pointer-events: none; display: flex; gap: 10px; }
.info-divider { width: 1px; height: 10px; background: var(--ui-border); }
.info-label { color: var(--text-muted); margin-right: 4px; }

/* --- МОДАЛЬНЫЕ ОКНА (АДАПТИВНЫЕ СТИЛИ) --- */
#modal-overlay, #cable-modal-overlay, #task-modal-overlay { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); 
    z-index: 10000; 
    display: none; 
    justify-content: center; align-items: center; 
}

#modal-box, #cable-modal-box, #task-modal-box { 
    background: var(--ui-bg); 
    border: 1px solid var(--ui-border); 
    border-radius: 4px; 
    padding: 24px; 
    width: 340px; 
    color: var(--text-color); 
    box-shadow: 0 15px 50px rgba(0,0,0,0.5); /* Чуть мягче тень */
    display: flex; flex-direction: column; 
    gap: 16px; 
}

.modal-header, #modal-box h3 { 
    font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; 
    font-weight: 700; color: var(--text-color); margin: 0; 
    border-bottom: 1px solid var(--ui-border); padding-bottom: 10px; margin-bottom: 5px;
}

.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-group label { font-size: 11px; color: var(--text-muted); font-weight: 500; margin-left: 2px; }

/* СТИЛИ INPUT / SELECT (АДАПТИВНЫЕ) */
#modal-input, 
#cable-modal-box select, #cable-modal-box input, 
#task-modal-box select, #task-modal-box input, #task-modal-box textarea { 
    background: var(--input-bg); /* Теперь зависит от темы */
    border: 1px solid var(--input-border); 
    border-radius: 4px; 
    color: var(--text-color); 
    padding: 10px 12px; 
    font-family: 'Roboto Mono', monospace; 
    font-size: 12px; 
    width: 100%; 
    outline: none;
    transition: border-color 0.2s;
}

/* ОПЦИИ ВЫПАДАЮЩЕГО СПИСКА */
select option {
    background-color: var(--ui-bg);
    color: var(--text-color);
}

#task-modal-box textarea { resize: vertical; min-height: 60px; }

#modal-input:focus, 
#cable-modal-box select:focus, #cable-modal-box input:focus,
#task-modal-box select:focus, #task-modal-box input:focus, #task-modal-box textarea:focus { 
    border-color: var(--neon-blue); 
}

.select-wrapper::after { display: none !important; }

.modal-btns { display: flex; gap: 12px; justify-content: flex-end; margin-top: 10px; border-top: 1px solid var(--ui-border); padding-top: 15px; }
.modal-btn { padding: 8px 18px; border-radius: 4px; border: none; cursor: pointer; font-size: 12px; font-weight: 600; font-family: 'Roboto Mono'; transition: 0.2s; }
.modal-btn.secondary { background: rgba(128,128,128,0.2); color: var(--text-color); }
.modal-btn.secondary:hover { background: rgba(128,128,128,0.4); }
.modal-btn.primary { background: var(--neon-blue); color: #fff; }
.modal-btn.primary:hover { opacity: 0.8; }

/* SIDE PANELS & HELP & CONTEXT */
.side-panel { position: fixed; top: 60px; right: 20px; z-index: 5000; width: 300px; max-height: 80vh; background: var(--ui-bg); border-radius: 6px; border: 1px solid var(--ui-border); color: var(--text-color); transform: translateX(120%); transition: transform 0.3s; display: flex; flex-direction: column; visibility: hidden; }
.side-panel.open { transform: translateX(0); visibility: visible; }
.panel-header { padding: 10px 15px; border-bottom: 1px solid var(--ui-border); font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); display: flex; justify-content: space-between; align-items: center; }
.panel-body { padding: 15px; overflow-y: auto; }
.panel-close { cursor: pointer; }

#help-toggle-btn { position: absolute; top: 70px; right: 20px; z-index: 5000; width: 36px; height: 36px; background: var(--ui-bg); border: 1px solid var(--ui-border); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); cursor: pointer; font-family: 'Roboto Mono'; }
#help-toggle-btn:hover { color: var(--text-color); border-color: var(--text-color); }
.help-section { margin-bottom: 18px; }
.help-title { font-size: 11px; font-weight: 800; color: var(--neon-blue); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
.help-title svg { width: 14px; height: 14px; fill: var(--neon-blue); }
.help-row { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
.key-badge { background: #252525; border: 1px solid #555; border-radius: 4px; color: #eee; font-family: 'Roboto Mono', monospace; font-size: 10px; font-weight: 700; padding: 4px 8px; min-width: 45px; text-align: center; box-shadow: 0 2px 0 #111; flex-shrink: 0; }
.help-desc { font-size: 11px; color: var(--text-color); font-weight: 500; line-height: 1.2; }
.help-divider { width: 100%; height: 1px; background: var(--ui-border); margin: 15px 0; }
.help-text-row { margin-bottom: 8px; display: flex; flex-direction: column; gap: 2px; }
.help-label { font-size: 11px; font-weight: 700; color: var(--text-color); }

/* UTIL */
.select-wrapper { position: relative; }
.select-wrapper::after { content: '▼'; position: absolute; right: 10px; top: 10px; font-size: 10px; color: var(--text-muted); pointer-events: none; }
#file-input { display: none; }
body { opacity: 0; visibility: hidden; transition: opacity 0.3s; }
body.loaded { opacity: 1; visibility: visible; }

/* CONTEXT MENU */
#context-menu { display: none; position: absolute; z-index: 9000; background: var(--ui-bg); border: 1px solid var(--ui-border); border-radius: 2px; padding: 4px; flex-direction: column; gap: 2px; min-width: 180px; box-shadow: 4px 4px 15px rgba(0,0,0,0.2); }
.ctx-item { padding: 6px 10px; font-size: 11px; font-family: 'Roboto Mono', monospace; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text-color); transition: background 0.1s; border-radius: 2px; }
.ctx-item:hover { background: var(--neon-blue); color: #fff; }
.ctx-item:hover .ctx-icon { fill: #fff; }
.ctx-icon { width: 14px; height: 14px; fill: var(--text-muted); flex-shrink: 0; }
.ctx-divider { height: 1px; background: var(--ui-border); margin: 4px 0; }
.ctx-row { display: flex; gap: 4px; padding: 4px 8px; justify-content: flex-start; flex-wrap: wrap; }
.color-btn-mini { width: 14px; height: 14px; border-radius: 1px; border: 1px solid #555; cursor: pointer; box-sizing: border-box; }
.color-btn-mini:hover { transform: scale(1.2); border-color: #fff; z-index: 2; }
.weight-btn { flex: 1; height: 22px; background: rgba(128,128,128,0.2); border: 1px solid var(--ui-border); cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 2px; }
.weight-btn:hover { background: rgba(128,128,128,0.4); }
.ctx-slider { width: 100% !important; margin: 0 5px; height: 4px; }

/* BOM */
.bom-section-title { font-size: 10px; text-transform: uppercase; color: var(--neon-blue) !important; font-weight: 700; letter-spacing: 1px; margin-top: 12px; margin-bottom: 4px; padding-bottom: 2px; border-bottom: 1px solid var(--ui-border); }
.bom-row { display: flex; justify-content: space-between; align-items: center; padding: 3px 0; border-bottom: 1px solid rgba(128,128,128,0.1); }
.bom-label-main { font-size: 11px; font-weight: 600; color: var(--text-color); display: flex; align-items: center; }
.bom-label-sub { font-size: 9px; color: var(--text-muted); margin-left: 2px; }
.bom-value { font-family: 'Roboto Mono', monospace; font-size: 11px; font-weight: 600; color: var(--text-color); white-space: nowrap; }
.bom-color { width: 8px; height: 8px; border-radius: 50%; box-shadow: 0 0 4px currentColor; flex-shrink: 0; margin-right: 10px; }
.bom-total { margin-top: 10px; text-align: right; font-size: 13px; font-weight: 700; color: var(--active-color); border-top: 1px solid var(--ui-border); padding-top: 8px; }
.btn-export { margin-top: 10px; width: 100%; padding: 8px; background: rgba(0,0,0,0.2); border: 1px solid var(--active-color); border-radius: 4px; color: var(--text-color); font-family: 'Roboto Mono', monospace; font-size: 11px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; text-transform: uppercase; }
.btn-export:hover { background: rgba(0, 170, 0, 0.2); box-shadow: 0 0 10px rgba(0, 170, 0, 0.2); }

/* Point Ctrl */
.point-ctrl-wrapper { position: absolute; top: 0; left: 0; width: 0; height: 0; z-index: 10000; pointer-events: none; }
.point-palette-container { pointer-events: auto; position: absolute; right: 25px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 4px; background: var(--ui-bg); padding: 4px; border-radius: 2px; border: 1px solid var(--ui-border); box-shadow: 4px 4px 10px rgba(0,0,0,0.5); }
.mini-color-btn { width: 20px; height: 20px; border-radius: 2px; cursor: pointer; border: 1px solid #555; box-sizing: border-box; transition: 0.1s; }
.mini-color-btn:hover { border-color: #fff; transform: scale(1.1); z-index: 2; }
.point-delete-badge { pointer-events: auto; position: absolute; left: 25px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; background: var(--ui-bg); border: 1px solid var(--danger-color); border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; box-shadow: 4px 4px 10px rgba(0,0,0,0.5); }
.point-delete-badge svg { width: 14px; height: 14px; stroke: var(--danger-color); stroke-width: 2; fill: none; transition: 0.2s; }
.point-delete-badge:hover { background: var(--danger-color); }
.point-delete-badge:hover svg { stroke: #fff; }
.del-tooltip { position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background: #000; color: #fff; padding: 4px 8px; border-radius: 2px; font-size: 10px; font-family: 'Roboto Mono', monospace; white-space: nowrap; border: 1px solid #444; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; pointer-events: none; }
.point-delete-badge:hover .del-tooltip { opacity: 1; visibility: visible; }

.group-item { padding: 8px; background: rgba(0,0,0,0.2); border: 1px solid var(--ui-border); margin-bottom: 4px; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
.group-item.active { border-color: var(--neon-blue); background: rgba(0, 174, 239, 0.1); }
.group-name { font-size: 12px; font-family: 'Roboto Mono'; }
.btn-add-group { width: 100%; padding: 8px; background: transparent; border: 1px dashed var(--text-muted); color: var(--text-muted); margin-top: 10px; cursor: pointer; font-family: 'Roboto Mono'; font-size: 12px; }
.btn-add-group:hover { border-color: var(--text-color); color: var(--text-color); }
.group-status { width: 6px; height: 6px; background: #444; border-radius: 50%; margin-right: 8px; }
.group-item.active .group-status { background: var(--active-color); }

/* АДАПТИВНЫЕ МЕТКИ */
.neon-text-label { 
    font-family: 'Roboto Mono', monospace; font-size: 11px; font-weight: bold; 
    background: rgba(0,0,0,0.7); color: #fff !important; /* Текст на карте всегда белый для контраста */
    border: 1px solid var(--obj-color); border-radius: 2px; 
    padding: 4px 8px; width: max-content; min-width: 50px; max-width: 250px; 
    white-space: pre-wrap; overflow-wrap: break-word; text-align: center; 
    display: inline-block; text-shadow: none; 
    transform: translate(-50%, -50%); pointer-events: auto; cursor: pointer; user-select: none; 
}
.neon-hint { 
    background: var(--ui-bg); color: var(--text-color); 
    border: 1px solid var(--ui-border); padding: 6px 10px; 
    border-radius: 2px; font-family: 'Roboto Mono', monospace; 
    font-size: 11px; width: max-content; max-width: 300px; white-space: pre-wrap; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
}

/* ИСПРАВЛЕННЫЕ РАЗМЕРЫ (СВЕТЛАЯ ТЕМА) */
.label-box {
    font-family: 'Roboto Mono', monospace; 
    font-size: 11px; font-weight: 700;
    background: var(--ui-bg); /* Адаптивный фон */
    color: var(--text-color); /* Адаптивный текст */
    border: 1px solid var(--text-muted); border-radius: 2px;
    padding: 2px 6px; 
    white-space: nowrap !important; 
    display: inline-block; 
    box-shadow: 2px 2px 4px rgba(0,0,0,0.2); 
    line-height: 1; 
    z-index: 1000;
}
/* --- MOBILE OPTIMIZATION --- */
@media (max-width: 600px) {
    /* Скрываем лишние кнопки на телефоне, чтобы влезло */
    #btn-load, #btn-save, #btn-ruler, #btn-bom {
        display: none;
    }
    
    /* Увеличиваем размер кнопок для пальцев */
    .icon-btn {
        width: 40px; 
        height: 40px;
    }
    
    /* Уменьшаем масштаб, чтобы видеть больше карты */
    :root {
        --icon-scale: 0.6;
    }
    
    /* Левая панель чуть ниже */
    #left-panel {
        top: 80px;
    }
}
